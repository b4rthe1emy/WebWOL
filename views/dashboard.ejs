<h2>Wake a Device</h2>

<p>
    Logged in as <strong><%= username %></strong> -
    <a href="/logout">Log out</a>
</p>

<% if (error) { %>
    <blockquote style="border-left: 4px solid red;">
        <strong><%= error %></strong>
    </blockquote>
<% } %>

<div
        x-data="wolApp(<%- JSON.stringify(savedMacAddresses).replaceAll("\"", "\'") %>)"
        x-init="init()"
>

    <form method="POST" action="/wake" @submit="handleSubmit">

        <label for="targetMac">Target MAC Address</label>

        <!-- Dropdown -->
        <select x-model="selectedMac" id="selectedMac">
            <option value="" x-text="favorites.length ? 'Saved Devices' : 'No Saved Devices'">
                <span></span>
            </option>

            <template x-for="device in favorites" :key="device.MAC">
                <option :value="device.MAC" x-text="device.label"></option>
            </template>
        </select>

        <!-- MAC Input -->
        <input
                type="text"
                name="targetMac"
                id="targetMac"
                x-model="mac"
                @input="formatMacInput"
                placeholder="AA:BB:CC:DD:EE:FF"
                required
        >

        <!-- Favorite Toggle -->
        <button
                type="button"
                @click="toggleFavorite"
                x-text="isFavorite ? 'Remove from favorites' : 'Add to favorites'"
                :disabled="!isValidMac"
        ></button>

        <br>

        <!-- Send Button -->
        <button
                type="submit"
                :disabled="!isValidMac"
        >
            Send Wake-on-LAN Packet
        </button>

    </form>

    <!-- Modal -->
    <div
            x-show="showModal"
            x-transition
            style=""
    >
        <div style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center;">
            <div style="background-color:inherit; padding:20px; border-radius:8px; max-width:400px; width:90%;">
                <h3>Add Favorite Device</h3>

                <label>Display Name</label>
                <input type="text" x-model="modalLabel" placeholder="My PC">

                <label>MAC Address</label>
                <input
                        type="text"
                        x-model="modalMac"
                        @input="formatModalMac"
                        placeholder="AA:BB:CC:DD:EE:FF"
                >

                <div style="margin-top:15px; text-align:right;">
                    <button type="button" @click="showModal = false">Cancel</button>
                    <button type="button" @click="saveFavorite">Save</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    function wolApp(initialFavorites) {
        return {

            /* -------------------------
               STATE
            -------------------------- */

            mac: '',
            selectedMac: '',
            favorites: initialFavorites.map(f => ({
                MAC: f.MAC.toUpperCase(),
                label: f.label
            })),
            showModal: false,
            modalLabel: '',
            modalMac: '',

            /* -------------------------
               INIT
            -------------------------- */

            init() {
                this.$watch('selectedMac', value => {
                    this.mac = value;
                });
            },

            /* -------------------------
               MAC UTILITIES
            -------------------------- */

            normalize(mac) {
                return mac.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
            },

            format(mac) {
                const cleaned = this.normalize(mac).substring(0, 12);
                return cleaned.match(/.{1,2}/g)?.join(':') || '';
            },

            get isValidMac() {
                return /^[0-9A-F]{2}(:[0-9A-F]{2}){5}$/.test(this.mac);
            },

            get isFavorite() {
                return this.favorites.some(f => f.MAC === this.mac);
            },

            /* -------------------------
               INPUT HANDLING
            -------------------------- */

            formatMacInput() {
                this.mac = this.format(this.mac);

                if (!this.favorites.some(f => f.MAC === this.mac)) {
                    this.selectedMac = '';
                } else {
                    this.selectedMac = this.mac;
                }
            },

            formatModalMac() {
                this.modalMac = this.format(this.modalMac);
            },

            /* -------------------------
               FAVORITES
            -------------------------- */

            toggleFavorite() {

                if (!this.isValidMac) return;

                if (this.isFavorite) {

                    fetch('/favorites/remove', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({MAC: this.mac})
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                this.favorites = this.favorites.filter(f => f.MAC !== this.mac);
                                this.selectedMac = '';
                            }
                        });

                } else {

                    this.modalMac = this.mac;
                    this.modalLabel = this.mac;
                    this.showModal = true;
                }
            },

            saveFavorite() {

                if (!/^[0-9A-F]{2}(:[0-9A-F]{2}){5}$/.test(this.modalMac)) return;

                const label = this.modalLabel || this.modalMac;

                fetch('/favorites/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        MAC: this.modalMac,
                        label
                    })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {

                            this.favorites.push({
                                MAC: this.modalMac,
                                label
                            });

                            this.mac = this.modalMac;
                            this.selectedMac = this.modalMac;
                            this.showModal = false;
                        }
                    });
            },

            /* -------------------------
               FORM SUBMIT
            -------------------------- */

            handleSubmit(event) {

                if (!this.isValidMac) {
                    event.preventDefault();
                    return;
                }

                // Normalize before submit
                this.mac = this.normalize(this.mac);
            }
        }
    }
</script>